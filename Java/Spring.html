<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring应用与源码分析 | HZH BLOG</title>
    <meta name="description" content="我的博客">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.66d45a11.css" as="style"><link rel="preload" href="/assets/js/app.bd83f740.js" as="script"><link rel="preload" href="/assets/js/2.8f600e53.js" as="script"><link rel="preload" href="/assets/js/8.28d0222e.js" as="script"><link rel="prefetch" href="/assets/js/10.1d310c99.js"><link rel="prefetch" href="/assets/js/11.f76918bf.js"><link rel="prefetch" href="/assets/js/12.f55c6a36.js"><link rel="prefetch" href="/assets/js/13.be8b846f.js"><link rel="prefetch" href="/assets/js/14.39795cc9.js"><link rel="prefetch" href="/assets/js/15.493fd799.js"><link rel="prefetch" href="/assets/js/16.8870c587.js"><link rel="prefetch" href="/assets/js/17.67e49c50.js"><link rel="prefetch" href="/assets/js/18.c17bbe7a.js"><link rel="prefetch" href="/assets/js/19.4c37f1fa.js"><link rel="prefetch" href="/assets/js/20.b4309ce1.js"><link rel="prefetch" href="/assets/js/21.025c2b93.js"><link rel="prefetch" href="/assets/js/3.83f27fa1.js"><link rel="prefetch" href="/assets/js/4.181f67ed.js"><link rel="prefetch" href="/assets/js/5.c6d93129.js"><link rel="prefetch" href="/assets/js/6.036b0968.js"><link rel="prefetch" href="/assets/js/7.7f15afd9.js"><link rel="prefetch" href="/assets/js/9.0bebed08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.66d45a11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HZH BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring应用与源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Java/Spring.html#spring初始化" class="sidebar-link">Spring初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/Spring.html#bean生命周期与循环依赖" class="sidebar-link">Bean生命周期与循环依赖</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring应用与源码分析"><a href="#spring应用与源码分析" class="header-anchor">#</a> Spring应用与源码分析</h1> <h2 id="spring初始化"><a href="#spring初始化" class="header-anchor">#</a> Spring初始化</h2> <h3 id="bean生命周期与循环依赖"><a href="#bean生命周期与循环依赖" class="header-anchor">#</a> Bean生命周期与循环依赖</h3> <p>用以下语句启动ioc容器，研究一下代码内部逻辑？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AnnotationConfigApplicationContext</span> ac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>AnnotationConfigApplicationContext 类图：
<img src="/assets/img/app-context.adf8a480.png" alt="An image"></p> <p>构造函数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> componentClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">register</span><span class="token punctuation">(</span>componentClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_1-this"><a href="#_1-this" class="header-anchor">#</a> 1.this()</h4> <p>首先会执行父类的构造方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//初始化一个工厂类，用于创建bean对象</span>
<span class="token keyword">public</span> <span class="token class-name">GenericApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>DefaultListableBeanFactory工厂类重要属性：</p> <p>1.beanDefinitionMap 存放BeanDefinition （所有交给spring管理的类/依赖注入的类，都会交给BeanDefinition）</p> <p>2.beanDefinitionNames 存放bean name</p></div> <p>父类构造完成之后，那么来看子类（AnnotationConfigApplicationContext）中的初始化。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 初始化一个AnnotatedBeanDefinition读取器，用于读取被注解标注的bean，
     * 读取的信息存放入AnnotatedBeanDefinition
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 初始化一个扫描器，用于扫描类或者包下的所有类，将被注解标注的bean生成对应的AnnotatedBeanDefinition
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_2-register-componentclasses-注册配置类"><a href="#_2-register-componentclasses-注册配置类" class="header-anchor">#</a> 2.register(componentClasses) 注册配置类</h4> <p>首先会循环注册bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> componentClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//循环注册bean</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> componentClass <span class="token operator">:</span> componentClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerBean</span><span class="token punctuation">(</span>componentClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_3-refresh"><a href="#_3-refresh" class="header-anchor">#</a> 3.refresh()</h4> <p>首先进入AbstractApplicationContext.java的refresh()：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//完成扫描，把beanDefinition对象存储到beanDefinitionMap</span>
<span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//准备走Bean的生命周期</span>
<span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接着进入finishBeanFactoryInitialization（）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//实例化所有的单例，非懒加载</span>
beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着进入ConfigurableListableBeanFactory抽象类的DefaultListableBeanFactory#preInstantiateSingletons()</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token comment">//得到所有的beanDefinition的名字</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 省略部分：遍历验证beanDefinition

<span class="token comment">//便利beanNames，开始getBean  (重点开始)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">doGetBean用到的重要缓存池对象介绍</p> <p>1.Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256)</p> <p>单例缓存池，生产好的单例bean都放在这里,getBean就是从这里拿的</p> <p>2.Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16)</p> <p>二级缓存池，用于存工厂对象，在解决循环依赖里，用来存bean工厂对象</p> <p>3.Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16)</p> <p>三级缓存池，用于解决循环依赖</p> <p>4.set&lt;&gt; singletonsCurrentlyInCreation</p> <p>表示当前对象是否在创建当中</p></div> <p>doGetBean来到了AbstractBeanFactory#doGetBean()</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">//重点方法： 尝试从缓存池中获取对象</span>
<span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>

    <span class="token comment">//判断这个类是不是在创建过程中，若出现循环依赖，判断bean是不是单例的，不是就抛异常,与sharedInstance有联系</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 各种验证

    <span class="token comment">//准备开始创建bean了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//getSingleton : 标识当前的bean正在被创建</span>
        sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//完成了目标对象的创建</span>
                <span class="token comment">//真正开始创建bean，前面都是扫描与验证过程</span>
                <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Explicitly remove instance from singleton cache: It might have been put there</span>
                <span class="token comment">// eagerly by the creation process, to allow for circular reference resolution.</span>
                <span class="token comment">// Also remove any beans that received a temporary reference to the bean.</span>
                <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>
注意：上面代码片段中<span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法是循环依赖的核心方法
举例解释<span class="token operator">:</span>
当前有一个<span class="token class-name">A</span>类，在<span class="token class-name">A</span>类中依赖了<span class="token class-name">B</span>类，也可以说自动注入了<span class="token class-name">B</span>类
当前有一个<span class="token class-name">B</span>类，在<span class="token class-name">B</span>类中依赖了<span class="token class-name">A</span>类
首先注意，<span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>是一个重载方法
spring扫描到<span class="token class-name">A</span>类需要被实例化，第一次调用<span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span>，尝试去缓存池去拿对象，第一次拿是空的，这个先记着
接着在创建bean前面一步，再次调用了<span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>这次注意调用的是<span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span>
这次会在singletonsCurrentlyInCreation这个<span class="token class-name">Set</span>集合中记录当前类正在被创建
接下来会开始调用<span class="token function">createBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
首先spring会讲我们的<span class="token class-name">A</span>对象给<span class="token keyword">new</span>出来
如果支持循环依赖，则会把<span class="token class-name">Bean</span>工厂对象缓存到第二级缓存里去
接下来会执行到<span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法，这个方法主要做的事情就是填充属性，注意了！当前正在执行<span class="token class-name">A</span>类的创建流程，现在要给<span class="token class-name">A</span>类填充属性了，而<span class="token class-name">A</span>类
依赖了<span class="token class-name">B</span>类，因此发现了<span class="token class-name">B</span>类，接下来就会去<span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">B</span>类<span class="token punctuation">)</span>，于是又走了一遍<span class="token class-name">A</span>类一样的流程
继续完成<span class="token class-name">B</span>类的生命周期，此使缓存池状态如下<span class="token operator">:</span>
<span class="token class-name">Set</span>集合此使存了<span class="token class-name">A</span><span class="token punctuation">,</span><span class="token class-name">B</span>
二级缓存存了<span class="token class-name">A</span><span class="token punctuation">,</span><span class="token class-name">B</span>
接着<span class="token class-name">B</span>对象继续生命周期，当<span class="token class-name">B</span>对象的属性填充的时候发觉<span class="token class-name">B</span>对象又依赖与<span class="token class-name">A</span>
于是又去<span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>，这时候依然还是get不到<span class="token class-name">A</span>的，因为<span class="token class-name">A</span>还不是一个完整的<span class="token class-name">Bean</span>，此使还只是存在二级缓存内
然后继续<span class="token class-name">A</span>的生命周期，到<span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span>的时候，这次拿就不是空的了，这次能拿到一个<span class="token class-name">A</span>对象，为什么呢？
这时候可以讲讲<span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span>的具体逻辑了<span class="token operator">:</span>
先会从单例池里去拿，这时候拿不到是因为<span class="token class-name">A</span>对象还不是一个完整的bean，只是还正在创建当中
里面有个判断，如果当前对象正在创建中，就会从三级缓存里去拿，三级缓存拿不到，然后再去二级缓存去拿，
上面说到当前二级缓存里存了<span class="token class-name">A</span>，<span class="token class-name">B</span>，目前正在<span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>，那么就能拿到了<span class="token class-name">A</span>的工厂对象，接着再从工厂对象里面拿出一个对象放到三级缓存里面，
然后再把二级缓存删掉
当前缓存池状态如下：
<span class="token class-name">Set</span>集合此使存了<span class="token class-name">A</span><span class="token punctuation">,</span><span class="token class-name">B</span>
二级缓存存了<span class="token class-name">B</span>
三级缓存存了<span class="token class-name">A</span>
此时在给<span class="token class-name">B</span>填充<span class="token class-name">A</span>的时候，<span class="token class-name">A</span>能返回回去，那么被依赖的<span class="token class-name">B</span>类就是一个完整的bean了
<span class="token class-name">B</span>现在是个bean对象，也就能给<span class="token class-name">A</span>填充了
循环依赖就完美被解决

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>开始准备创建Bean，来到了AbstractAutowireCapableBeanFactory#createBean()</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">//要开始创建bean了！！ 在真正要干活前，spring通常会在名字前面加个do</span>
<span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>doCreateBean():</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 实例化对象，调用我们的构造方法，里面第二次调用后置处理器  （早期对象）
     */</span>
    instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">//判断是否允许循环依赖</span>
<span class="token comment">//1.bean是否是单例</span>
<span class="token comment">//2.系统配置是否允许循环依赖</span>
<span class="token comment">//3.当前bean是否正在创建</span>
<span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
        <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                <span class="token string">&quot;' to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//第四次调用后置处理器，判断是否需要AOP|||   暴露早期对象到三级缓存中</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">/**
 * 填充属性，完成自动注入
 * 里面会完成第五次和第六次后置处理器的调用
 */</span>
<span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//初始化spring</span>
<span class="token comment">//里面会进行第七次和第八次后置处理器的调用</span>
exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/4/2019, 4:34:52 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bd83f740.js" defer></script><script src="/assets/js/2.8f600e53.js" defer></script><script src="/assets/js/8.28d0222e.js" defer></script>
  </body>
</html>
