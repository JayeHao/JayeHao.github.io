<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud | HZH BLOG</title>
    <meta name="description" content="我的博客">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.66d45a11.css" as="style"><link rel="preload" href="/assets/js/app.bd83f740.js" as="script"><link rel="preload" href="/assets/js/2.8f600e53.js" as="script"><link rel="preload" href="/assets/js/3.83f27fa1.js" as="script"><link rel="prefetch" href="/assets/js/10.1d310c99.js"><link rel="prefetch" href="/assets/js/11.f76918bf.js"><link rel="prefetch" href="/assets/js/12.f55c6a36.js"><link rel="prefetch" href="/assets/js/13.be8b846f.js"><link rel="prefetch" href="/assets/js/14.39795cc9.js"><link rel="prefetch" href="/assets/js/15.493fd799.js"><link rel="prefetch" href="/assets/js/16.8870c587.js"><link rel="prefetch" href="/assets/js/17.67e49c50.js"><link rel="prefetch" href="/assets/js/18.c17bbe7a.js"><link rel="prefetch" href="/assets/js/19.4c37f1fa.js"><link rel="prefetch" href="/assets/js/20.b4309ce1.js"><link rel="prefetch" href="/assets/js/21.025c2b93.js"><link rel="prefetch" href="/assets/js/4.181f67ed.js"><link rel="prefetch" href="/assets/js/5.c6d93129.js"><link rel="prefetch" href="/assets/js/6.036b0968.js"><link rel="prefetch" href="/assets/js/7.7f15afd9.js"><link rel="prefetch" href="/assets/js/8.28d0222e.js"><link rel="prefetch" href="/assets/js/9.0bebed08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.66d45a11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HZH BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SpringCloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Java/SpringCloud.html#服务注册中心" class="sidebar-link">服务注册中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#eureka" class="sidebar-link">Eureka</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#zookeeper" class="sidebar-link">zookeeper</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#consul" class="sidebar-link">consul</a></li></ul></li><li><a href="/Java/SpringCloud.html#负载均衡于服务调用" class="sidebar-link">负载均衡于服务调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#ribbon" class="sidebar-link">Ribbon</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#openfeign" class="sidebar-link">OpenFeign</a></li></ul></li><li><a href="/Java/SpringCloud.html#服务降级" class="sidebar-link">服务降级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#hystrix断路器" class="sidebar-link">Hystrix断路器</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#hystrix图形化实时监控器" class="sidebar-link">Hystrix图形化实时监控器</a></li></ul></li><li><a href="/Java/SpringCloud.html#服务网关" class="sidebar-link">服务网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#gateway" class="sidebar-link">Gateway</a></li></ul></li><li><a href="/Java/SpringCloud.html#springcloud-config分布式配置中心" class="sidebar-link">SpringCloud Config分布式配置中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#spring-cloud-config-服务端" class="sidebar-link">spring-cloud-config 服务端</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#spring-cloud-config-客户端" class="sidebar-link">spring-cloud-config 客户端</a></li></ul></li><li><a href="/Java/SpringCloud.html#springcloud-bus消息总线" class="sidebar-link">SpringCloud Bus消息总线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#rabbitmq" class="sidebar-link">RabbitMQ</a></li></ul></li><li><a href="/Java/SpringCloud.html#springcloud-stream-消息驱动" class="sidebar-link">SpringCloud Stream 消息驱动</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#什么是springcloud-stream" class="sidebar-link">什么是SpringCloud Stream?</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#为什么要用springcloud-stream" class="sidebar-link">为什么要用SpringCloud Stream?</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#官网" class="sidebar-link">官网</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#binder" class="sidebar-link">Binder</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#springcloud-stream标准流程" class="sidebar-link">SpringCloud Stream标准流程</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#生产者于消费者" class="sidebar-link">生产者于消费者</a></li></ul></li><li><a href="/Java/SpringCloud.html#springcloud-sleuth分布式请求链路跟踪" class="sidebar-link">SpringCloud Sleuth分布式请求链路跟踪</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#为什么要出现这个技术？要解决的问题？" class="sidebar-link">为什么要出现这个技术？要解决的问题？</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloud.html#测试运行" class="sidebar-link">测试运行</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springcloud"><a href="#springcloud" class="header-anchor">#</a> SpringCloud</h1> <h2 id="服务注册中心"><a href="#服务注册中心" class="header-anchor">#</a> 服务注册中心</h2> <h3 id="eureka"><a href="#eureka" class="header-anchor">#</a> Eureka</h3> <p>引入Eureka --&gt; pom.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Eureka基本配置 --&gt; application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka7001.com   <span class="token comment">#eureka服务端的实例名称</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false   </span><span class="token comment">#false表示不向注册中心注册自己</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false   </span><span class="token comment">#表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#设置与Eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭自我保护机制，保证不可用服务被即使剔除</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>入口类加上@EnableEurekaServer注解来注册一下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaMain7001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaMain7001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接下来做个服务提供者 --&gt; pom.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--eureka client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示是否将自己注册进EurekaServer 默认true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#集群版</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001    <span class="token comment">#修改本服务名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true   </span><span class="token comment">#访问路径显示id地址</span>
    <span class="token comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认30秒)</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token comment">#Eureka服务端在收到最后一次心跳后等待时间上限，默认是90秒，超时将剔除服务</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>入口类加上@EnableEurekaClient、@EnableDiscoveryClient把我们的Eureka客户端注册上去</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来做我们的消费者，一样的先加pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--eureka client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示是否将自己注册进EurekaServer 默认true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#集群版</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>因为引入的是Eureka2.2.1版本，自带了ribbon，可以配置fetch-registry: true 来实现负载均衡，默认用的是轮询算法。</p></div> <p>然后启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMain80</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>启动之后可以看到有两个注册中心，两个提供者，一个消费者。
注册中心与提供者本文只介绍一个创建方法，如果需要集群，
多复制一个就行。</p> <p><img src="/assets/img/Eureka.1a409a0d.png" alt="An image"></p> <h3 id="zookeeper"><a href="#zookeeper" class="header-anchor">#</a> zookeeper</h3> <p>本文zookeeper在linux上演示</p> <div class="custom-block tip"><p class="custom-block-title">zookeeper 常用命令</p> <p>默认端口：2181</p> <p>启动 ：./zkServer.sh start</p> <p>登录：./zkCli.sh</p></div> <p>服务提供者：(这里由于有依赖冲突，排除了两个依赖)  --&gt; pom.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--   引入zookeeper客户端     --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--排除这个slf4j-log4j12--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>application.yml：注册到zookeeper，如果zookeeper集群，在connect-string加逗号即可</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
      <span class="token key atrule">connect-string</span><span class="token punctuation">:</span> 192.168.172.22<span class="token punctuation">:</span><span class="token number">2181</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>启动类：(加上@EnableDiscoveryClient)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8004</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8004</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接着消费者pom：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--   引入zookeeper客户端     --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--排除这个slf4j-log4j12--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>application.yml(基本和上面服务提供者一样)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> cloud<span class="token operator">-</span>consumer<span class="token operator">-</span>order
  cloud<span class="token operator">:</span>
    zookeeper<span class="token operator">:</span>
      connect<span class="token operator">-</span>string<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.172</span><span class="token number">.22</span><span class="token operator">:</span><span class="token number">2181</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>因为要以http调用提供者，加入RestTemplate。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>启动类：(加@EnableDiscoveryClient)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderZKMain80</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderZKMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Contriller用以下方法调用即可</p> <p>restTemplate.getForObject(提供者服务名+接口地址,返回entity)</p> <p>服务全部启动之后可以看到一个提供者与一个消费者</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <h3 id="consul"><a href="#consul" class="header-anchor">#</a> consul</h3> <p>本文演示在windows平台运行</p> <div class="custom-block tip"><p class="custom-block-title">consul常用命令</p> <p>默认端口：8500</p> <p>启动：consul agent -dev</p></div> <p>consul启动完成后做一个提供者  --&gt; pom.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- springCloud sonsul-server --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
<span class="token comment"># consul注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>启动类加上@EnableDiscoveryClient</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8006</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8006</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来消费者pom.xml:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- springCloud sonsul-server --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.yml:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>order
<span class="token comment"># consul注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>启动类加上@EnableDiscoveryClient（这里就省去RestTemplate环节了）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderConsulMain80</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderConsulMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>服务全部启动之后可以看到一个提供者与一个消费者</p> <p><img src="/assets/img/consul.a51b6631.png" alt="An image"></p> <h2 id="负载均衡于服务调用"><a href="#负载均衡于服务调用" class="header-anchor">#</a> 负载均衡于服务调用</h2> <h3 id="ribbon"><a href="#ribbon" class="header-anchor">#</a> Ribbon</h3> <h4 id="ribbon默认自带的负载规则"><a href="#ribbon默认自带的负载规则" class="header-anchor">#</a> Ribbon默认自带的负载规则</h4> <p>Ribbon核心组件Irule</p> <p>先来看看类结构：</p> <p><img src="/assets/img/IRule.551e2040.png" alt="An image"></p> <div class="custom-block tip"><p class="custom-block-title">根据特定算法中从服务列表中选取一个要访问的服务</p> <p>1.com.netflix.loadbalancer.RoundRobinRule
轮询</p> <p>2.com.netflix.loadbalancer.RandomRule
随机</p> <p>3.com.netflix.loadbalancer.RetryRule
先按照RoundRobinRule轮询的策略获取服务，如果获取服务失败则在指定时间内会进行充实，获取可用的服务</p> <p>4.WeightedResponseTimeRule
对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</p> <p>5.BestAvailableRule
会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</p> <p>6.AvailabilityFilteringRule
先过滤掉故障实例，再选择并发较小的实例</p> <p>7.ZoneAvoidanceRule
默认规则，符合判断server所在区域的性能和server的可用性选择服务器</p></div> <h4 id="尝试自己手写一个轮询算法"><a href="#尝试自己手写一个轮询算法" class="header-anchor">#</a> 尝试自己手写一个轮询算法</h4> <p>面向接口编程，先写个接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>lb</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client</span><span class="token punctuation">.</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 手写一个负载均衡
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalancer</span> <span class="token punctuation">{</span>

    <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>lb</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client</span><span class="token punctuation">.</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLB</span> <span class="token keyword">implements</span> <span class="token class-name">LoadBalancer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 拿到接口的请求数
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> current<span class="token punctuation">;</span>
        <span class="token keyword">int</span> next<span class="token punctuation">;</span>       <span class="token comment">//请求数</span>
        <span class="token keyword">do</span><span class="token punctuation">{</span>
            current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//接口请求数+1并防止请求数大于Integer类型的上限值</span>
            <span class="token comment">//2147483647是Integer的最大长度，为什么不用Integer.MAX_VALUE呢？</span>
            <span class="token comment">//因为Integer.MAX_VALUE会多创建一个栈区，写死了就不会</span>
            next <span class="token operator">=</span> current <span class="token operator">&gt;=</span> <span class="token number">2147483647</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> current <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">//一直自旋，取到我们想要的值为止</span>
        <span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;********第几次访问，次数next:&quot;</span><span class="token operator">+</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//轮询算法：接口请求次数 % 服务器集群总数量 = 实际调用服务器位置下标</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> serviceInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>Controller~~</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

<span class="token comment">//自己写的负载均衡算法</span>
<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">LoadBalancer</span> loadBalancer<span class="token punctuation">;</span>

<span class="token comment">/**
 * 测试自己手写的负载均衡
 * @return
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/lb&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPaymentLB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>instances <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">instances</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URI</span> uri <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>uri<span class="token operator">+</span><span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>上面CLOUD-PAYMENT-SERVICE服务接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPaymentLB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> serverPort<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>测试结果：第一次调用</p> <p><img src="/assets/img/ribbon-8001.2ee0e1f5.png" alt="An image"></p> <p>第二次调用</p> <p><img src="/assets/img/ribbon-8002.cfeefaa6.png" alt="An image"></p> <h3 id="openfeign"><a href="#openfeign" class="header-anchor">#</a> OpenFeign</h3> <h4 id="openfeign是什么？"><a href="#openfeign是什么？" class="header-anchor">#</a> OpenFeign是什么？</h4> <p>Feign是一个声明式WebService客户端。使用Feign能让编写WebService客户端更加简单。
它得使用方法是定义一个服务接口然后在上面添加注解，Feign也支持可插拔式的编码和解码器。Spring Cloud对Feign进行了
封装，使其支持了SpringMvc标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用以支持负载均衡</p> <h4 id="开始使用openfeign"><a href="#开始使用openfeign" class="header-anchor">#</a> 开始使用OpenFeign</h4> <p>添加pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示是否将自己注册进EurekaServer 默认true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot</span><span class="token punctuation">.</span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure</span><span class="token punctuation">.</span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign</span><span class="token punctuation">.</span><span class="token class-name">EnableFeignClients</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>     <span class="token comment">//使用feign</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignMain80</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderFeignMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>业务接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>entities</span><span class="token punctuation">.</span><span class="token class-name">CommonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>entities</span><span class="token punctuation">.</span><span class="token class-name">Payment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign</span><span class="token punctuation">.</span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span>     <span class="token comment">//表示调用某个服务</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>        <span class="token comment">//表示调用某个服务下的某个接口</span>
    <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>entities</span><span class="token punctuation">.</span><span class="token class-name">CommonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>entities</span><span class="token punctuation">.</span><span class="token class-name">Payment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">PaymentFeignService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentFeignService</span> paymentFeignService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentFeignService<span class="token punctuation">.</span><span class="token function">getPaymentById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Feign依赖了Ribbon，所以自带负载均衡功能，默认轮询，测试：</p> <p><img src="/assets/img/fegin_1.9f817a02.png" alt="An image"></p> <p><img src="/assets/img/fegin_2.56469e55.png" alt="An image"></p> <h4 id="openfeign超时控制"><a href="#openfeign超时控制" class="header-anchor">#</a> OpenFeign超时控制</h4> <p>OpenFeign默认等待1s，超时则会抛feign.FeignException$NotFound异常</p> <p>application.yml 设置fegin客户端超时时间</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code># 设置feign客户端超时时间（<span class="token class-name">OpenFeign</span>默认支持ribbon）
ribbon<span class="token operator">:</span>
  #建立连接所用的时间<span class="token punctuation">,</span>适用于网络状况正常的情况下<span class="token punctuation">,</span>两端连接所用的时间
  <span class="token class-name">ReadTimeout</span><span class="token operator">:</span> <span class="token number">5000</span>
  <span class="token class-name">ConnectTimeout</span><span class="token operator">:</span> <span class="token number">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="openfeign日志打印"><a href="#openfeign日志打印" class="header-anchor">#</a> OpenFeign日志打印</h4> <div class="custom-block tip"><p class="custom-block-title">日志级别</p> <p>NONE：默认的，不显示任何日志</p> <p>BASIC：仅记录请求方法、URL、响应状态码及执行时间</p> <p>HEADERS：除了BASIC中定义的信息之外，还有请求和响应头信息</p> <p>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据</p></div> <h5 id="开始使用"><a href="#开始使用" class="header-anchor">#</a> 开始使用</h5> <p>添加一个Feginconfig类，配置日志级别</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> feign<span class="token punctuation">.</span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeginConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>application.yml添加相关日志配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token comment"># feign日志以什么级别监控哪个接口</span>
    <span class="token key atrule">com.hzh.springcloud.service.PaymentFeignService</span><span class="token punctuation">:</span> debug
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>控制台输出</p> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2020-03-18 17:48:35.734 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] ---&gt; GET http://CLOUD-PAYMENT-SERVICE/payment/get/1 HTTP/1.1
2020-03-18 17:48:35.734 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] ---&gt; END HTTP (0-byte body)
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] &lt;--- HTTP/1.1 200 (60ms)
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] connection: keep-alive
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] content-type: application/json
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] date: Wed, 18 Mar 2020 09:48:35 GMT
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] keep-alive: timeout=60
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] transfer-encoding: chunked
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] 
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] {&quot;code&quot;:200,&quot;message&quot;:&quot;查询成功,serverPort:8001&quot;,&quot;data&quot;:{&quot;id&quot;:1,&quot;serial&quot;:&quot;123123&quot;}}
2020-03-18 17:48:35.795 DEBUG 4328 --- [-nio-80-exec-10] c.h.s.service.PaymentFeignService        : [PaymentFeignService#getPaymentById] &lt;--- END HTTP (87-byte body)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="服务降级"><a href="#服务降级" class="header-anchor">#</a> 服务降级</h2> <h3 id="hystrix断路器"><a href="#hystrix断路器" class="header-anchor">#</a> Hystrix断路器</h3> <h4 id="hystrix断路器重要概念"><a href="#hystrix断路器重要概念" class="header-anchor">#</a> Hystrix断路器重要概念</h4> <p>1.服务降级</p> <p>服务器忙，请稍后再试，不让客户端等待立刻返回一个友好提示，fallback</p> <p>那些情况会触发降级？</p> <p>1）程序运行异常</p> <p>2）超时</p> <p>3）服务熔断触发服务降级</p> <p>4）线程池/信号量打满也会导致服务降级</p> <p>2.服务熔断</p> <p>类比保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回一个友好的提示</p> <p>3.服务限流</p> <p>秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行</p> <h4 id="使用hystrix服务降级"><a href="#使用hystrix服务降级" class="header-anchor">#</a> 使用Hystrix服务降级</h4> <p>引入pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- hystrix --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>启动类@EnableCircuitBreaker激活</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot</span><span class="token punctuation">.</span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure</span><span class="token punctuation">.</span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>circuitbreaker</span><span class="token punctuation">.</span><span class="token class-name">EnableCircuitBreaker</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka</span><span class="token punctuation">.</span><span class="token class-name">EnableEurekaClient</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>   <span class="token comment">//激活hystrix</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixMain8001</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentHystrixMain8001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>业务类，假设paymentInfo_TimeOut处理完成要5秒，必须要在3秒内给客户端响应请求，不能让其一直等待
则需要加入以下配置，处理超时则在规定时间内返回繁忙提示。
如果抛异常，也会调用paymentInfo_TimeOutHandler方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentInfo_TimeOutHandler&quot;</span><span class="token punctuation">,</span>commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>     <span class="token comment">////如果异常了就进入paymentInfo_TimeOutHandler</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;3000&quot;</span><span class="token punctuation">)</span>      <span class="token comment">//规定3秒以内视为正常调用</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> timeNum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;线程池：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; paymentInfo_TimeOut,id:&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;正常访问ok&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;耗时：&quot;</span><span class="token operator">+</span>timeNum<span class="token operator">+</span><span class="token string">&quot;秒&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * paymentInfo_TimeOut超时或异常后执行
 * @param id
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOutHandler</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;线程池：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; paymentInfo_TimeOutHandler,id:&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;繁忙请稍后再说/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面是介绍在服务提供端，在消费端也能用，接着演示一个全局与特有fallback的类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">PaymentHystrixService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">DefaultProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;payment_Global_FallbackMethod&quot;</span><span class="token punctuation">)</span>   <span class="token comment">//使用全局fallback方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderHystrixController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixService</span> paymentHystrixService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/hystrix/ok/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//    @HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;,commandProperties = {</span>
<span class="token comment">//            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span>
<span class="token comment">//    })</span>
    <span class="token annotation punctuation">@HystrixCommand</span> <span class="token comment">//使用全局响应</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//int age = 10/0;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentTimeOutFallbackMethod</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;我是消费者80，对方支付系统繁忙请10秒种后再试或者自己运行出错请检查自己&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 全局fallback方法
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Global异常处理信息，请稍后再试&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>如果没使用全局就调用paymentTimeOutFallbackMethod()。</p> <p>如果使用全局就调用payment_Global_FallbackMethod()。</p> <p>发现以上代码耦合性太高了，业务代码与异常代码混在一起了，接着来做一下解耦</p> <p>首先从消费端的service层改造，因为使用Feign调用服务都在这个接口，可以实现这个接口来对其进行改造</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">PaymentFallbackService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/ok/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>做一个PaymentFallbackService类来实现以上接口，从而可以对每个接口做服务降级</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallbackService</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-------PaymentFallbackService fall paymentInfo_OK,/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-------PaymentFallbackService fall paymentInfo_TimeOut,/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>还要再application.yml中的feign来开启Hystrix</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>feign<span class="token operator">:</span>
  hystrix<span class="token operator">:</span>
    enabled<span class="token operator">:</span> <span class="token boolean">true</span> #在<span class="token class-name">Feign</span>中开启<span class="token class-name">Hystrix</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>测试结果：
如果调用paymentInfo_OK，发生服务降级则会return &quot;-------PaymentFallbackService fall paymentInfo_OK,/(ㄒoㄒ)/~~&quot;;</p> <h4 id="服务熔断"><a href="#服务熔断" class="header-anchor">#</a> 服务熔断</h4> <p>熔断类型：</p> <p>1）熔断打开</p> <p>请求不再进行调用当前服务，内部设置时钟一般为MTTR（平均故障处理时间），当打开长达 到所设时间则进入半熔断状态</p> <p>2）熔断关闭</p> <p>熔断关闭不会对服务进行熔断</p> <p>3）熔断半开</p> <p>部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务回复正常，关闭熔断</p> <p>服务熔断演示:以下代码片段设置了断路器如果在10秒内访问10次失败率达到60%就会拉闸</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentCircuitBreaker_fallback&quot;</span><span class="token punctuation">,</span>commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.enabled&quot;</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">//是否开启断路器</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//请求次数</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.sleepWindowInMilliseconds&quot;</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">//时间窗日期</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.errorThresholdPercentage&quot;</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;60&quot;</span><span class="token punctuation">)</span>      <span class="token comment">//失败率达到百分之多少后跳闸</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;id不能为负数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> serialNumber <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;调用成功，流水号：&quot;</span><span class="token operator">+</span>serialNumber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker_fallback</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;id不能为负数，请稍后再试，/(ㄒoㄒ)/~~  id:&quot;</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="服务限流"><a href="#服务限流" class="header-anchor">#</a> 服务限流</h4> <p>由于Hystrix已经停止更新，这个侧重点移到其他主流并没有停止更新的服务降级框架中学习</p> <h3 id="hystrix图形化实时监控器"><a href="#hystrix图形化实时监控器" class="header-anchor">#</a> Hystrix图形化实时监控器</h3> <p>监控者 ---&gt; pom.xml</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- Hystrix实时监控仪表盘 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>监控着主启动类上加上@EnableHystrixDashboard表示开启监控器</p> <p>地址栏配置http://localhost:监控器工程端口号/hystrix   访问到主页面</p> <p><img src="/assets/img/HystrixDashboard_1.5bdd403e.png" alt="An image"></p> <p>输入地址+端口/hystrix.stream 即可进入监控主页面</p> <p><img src="/assets/img/HystrixDashboard_2.360347c7.png" alt="An image"></p> <h4 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h4> <p>注意被监控者一定要有以下依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>被监控者的主启动类要有以下Bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑
 * ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;
 * 只要在自己的项目里配置上下面的servlet就可以了
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix.stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;HystrixMetricsStreamServlet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="服务网关"><a href="#服务网关" class="header-anchor">#</a> 服务网关</h2> <h3 id="gateway"><a href="#gateway" class="header-anchor">#</a> Gateway</h3> <h4 id="gateway三大核心概念"><a href="#gateway三大核心概念" class="header-anchor">#</a> Gateway三大核心概念</h4> <p>Route(路由)</p> <p>路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</p> <p>Predicate(断言)</p> <p>参考的是Java8的java.util.function.Predicate</p> <p>开发人员可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</p> <p>Filter(过滤)</p> <p>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改</p> <h4 id="引入gateway"><a href="#引入gateway" class="header-anchor">#</a> 引入gateway</h4> <p>pom.xml，网关是不需要web模块，注意要把web模块去掉</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- gateway --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment">#开启从注册中心动态创建路由的功能，利用微服务名j进行路由</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token comment">#uri: http://localhost:8001  #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/**  <span class="token comment">#断言，路径相匹配的进行l路由</span>

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2 <span class="token comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token comment">#uri: http://localhost:8001  #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/**  <span class="token comment">#断言，路径相匹配的进行l路由</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>service
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>启动成功后，访问9527的接口就能路由到8001上</p> <p>更多路由规则和过滤器使用参考spring Gateway官方文档</p> <p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/#gateway-request-predicates-factories" target="_blank" rel="noopener noreferrer">Gateway官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="自定义过滤器"><a href="#自定义过滤器" class="header-anchor">#</a> 自定义过滤器</h4> <p>gateway自定义过滤器实现GlobalFilter, Ordered接口即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core</span><span class="token punctuation">.</span><span class="token class-name">Ordered</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * gateway自定义过滤器
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogGateWayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;**************come in MyLogGateWayFilter&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uname <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;uname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>uname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;*****用户名null,非法用户&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>NOT_ACCEPTABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="springcloud-config分布式配置中心"><a href="#springcloud-config分布式配置中心" class="header-anchor">#</a> SpringCloud Config分布式配置中心</h2> <h3 id="spring-cloud-config-服务端"><a href="#spring-cloud-config-服务端" class="header-anchor">#</a> spring-cloud-config 服务端</h3> <h4 id="使用spring-cloud-config通过github获取配置信息"><a href="#使用spring-cloud-config通过github获取配置信息" class="header-anchor">#</a> 使用spring-cloud-config通过GitHub获取配置信息</h4> <p>引入pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- config seriver --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>GitHub：</p> <p><img src="/assets/img/github_config.7327dd1c.png" alt="An image"></p> <p>yml：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/JayeHao/springcloud<span class="token punctuation">-</span>config.git  <span class="token comment">#Github上面的git仓库名字</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> username
          <span class="token key atrule">password</span><span class="token punctuation">:</span> password
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> springcloud<span class="token punctuation">-</span>config    <span class="token comment">#搜索目录</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master   <span class="token comment">#读取分支</span>

<span class="token comment">#服务注册到eureka</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>启动后访问http://localhost:3344/master/config-prod.yml可以看到下图，即读取GitHub配置成功</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>访问规则</p> <div class="custom-block tip"><p class="custom-block-title">访问规则</p> <p>/{label}/{application}-{profile}.yml</p> <p>/{application}-{profile}.yml
默认访问master分支</p> <p>/{application}/{profile}[/{label}]
返回json</p> <p>label: 分支</p> <p>name：服务名</p> <p>profiles：环境(dev/test/prod)</p></div> <h3 id="spring-cloud-config-客户端"><a href="#spring-cloud-config-客户端" class="header-anchor">#</a> spring-cloud-config 客户端</h3> <p>引入客户端pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- config 客户端 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>新建bootstrap.yml，为什么要用bootstrap呢？来看下面介绍</p> <div class="custom-block tip"><p class="custom-block-title">bootstrap是什么？</p> <p>application.yml是用户级的资源配置项</p> <p>bootstrap.yml是系统级的，优先级更高</p> <p>Spring Cloud会创建一个“Bootstrap Context”，作为spring应用的“application Context”的父上下文。
初始化的时候，“Bootstrap Context”负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部
获取的“Environment”。</p> <p>“Bootstrap”属性有高优先级，默认情况下，它们不会被本地配置覆盖。“BootStrap context”和“Application context”
有着不同约定，所以新增了一个“bootstrap.yml”文件，保证“bootstrap Context”和“Application Context”配置的分离。</p> <p>要将Client模块下的application.yml文件改为bootstrap.yml，这是很关键的。
因为bootstrap.yml是比application.yml先加载的。bootstrap.yml优先级高于
application.yml</p></div> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment">#config客户端配置</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master <span class="token comment">#分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token comment">#配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev  <span class="token comment">#读取后缀名称</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344  </span><span class="token comment">#配置中心地址</span>

<span class="token comment">#服务注册到eureka</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>接着Controller通过@Value(&quot;${config.info}&quot;)就从配置中心获取到相关配置信息</p> <p>客户端动态更新github上的配置：</p> <p>1.注意pom要有spring-boot-starter-actuator监控依赖</p> <p>2.暴露监控端点，修改bootstrap.yml：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 暴露监控端点(用于动态加载配置)</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>3.Controller加@RefreshScope。</p> <p>自测因为加了@RefreshScope之后发现获取不到配置了，所以新增一个配置类来放配置属性</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parmeters</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>config</span><span class="token punctuation">.</span><span class="token class-name">Parmeters</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 从3344拿配置信息
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">Parmeters</span> parmeters<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> parmeters<span class="token punctuation">.</span><span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>4.需要发送一个post请求让客户端刷新，以windows平台的curl为例发送</p> <p>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;</p> <p>测试结果</p> <p>在github推送后，没发post请求前：</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>发送post请求后可以发现实现动态刷新</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <h2 id="springcloud-bus消息总线"><a href="#springcloud-bus消息总线" class="header-anchor">#</a> SpringCloud Bus消息总线</h2> <h3 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h3> <p>在Windows平台安装</p> <p>1.需要安装Erlang和RobbitMQ</p> <p>2.在RoobbitMQ安装目录的sbin下执行命令(安装可视化插件)：
rabbitmq-plugins enable rabbitmq_management</p> <p>3.启动RobbitMQ后访问地址是否安装成功：
http://localhost:15672</p> <p>4.默认登录账号密码：
guest</p> <p>开始使用RabbitMQ</p> <p>这里有三个服务，3344是服务总线/configServer的服务端/配置中心，3355和3366是configServer的客户端</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>1.在3344添加RabbitMQ的支持</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2.3344application.yml添加RabbitMQ相关配置（在这之前已经配置好git与eureka）</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment">#rabbitMQ相关配置</span>
<span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
  <span class="token key atrule">password</span><span class="token punctuation">:</span> guest

<span class="token comment">#暴露bus刷新配置的端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'bus-refresh'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>3.3355和3366的修改</p> <p>添加rabbitMQ支持</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>bootstrap.yml，这里注意rabbitmq与application同级。
在前面的加载动态配置有指出暴露，所以这里不写。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment">#config客户端配置</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master <span class="token comment">#分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token comment">#配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev  <span class="token comment">#读取后缀名称</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344  </span><span class="token comment">#配置中心地址</span>
  <span class="token comment">#rabbitMQ相关配置</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>4.开始测试</p> <p>服务启动可以看到eureka上都已注册好，启动没问题</p> <p><img src="/assets/img/eureka_config_server.ad41b1a2.png" alt="An image"></p> <p>首先看3344总线上的版本号信息：</p> <p><img src="/assets/img/text_3344.38ae0118.png" alt="An image"></p> <p>3355和3366上的版本号：</p> <p><img src="/assets/img/test_3355.821f6758.png" alt="An image"></p> <p>目前服务上的配置信息都是最新的，接下来改动提交github</p> <p>提交完成后看看3344和3355，3366上的信息</p> <p><img src="/assets/img/test3344_01.18ebd82d.png" alt="An image"></p> <p>3355、3366</p> <p><img src="/assets/img/test_3355_01.eaf538ac.png" alt="An image"></p> <p>可以看到3355、3366并没有更新。
刷新一下3344总线：curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</p> <p>完成之后发现3355、3366更新完成</p> <p><img src="/assets/img/test3355_02.e8647ede.png" alt="An image"></p> <p>3366</p> <p><img src="/assets/img/test3366_02.4a09be0c.png" alt="An image"></p> <p>一次发送，广播通知，处处生效。</p> <p>说完全局广播，再说说定点通知</p> <p>给配置中心发送：
http://配置中心域名和端口/actuator/bus-refresh/{destination}</p> <p>例如只通知3355（config-client是3355服务名）：</p> <div class="language-cmd line-numbers-mode"><pre class="language-text"><code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh/config-client:3355
# 多个定点通知
curl -X POST &quot;http://localhost:3344/actuator/bus-refresh/{config-client:3355,config-client:3366}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="springcloud-stream-消息驱动"><a href="#springcloud-stream-消息驱动" class="header-anchor">#</a> SpringCloud Stream 消息驱动</h2> <h3 id="什么是springcloud-stream"><a href="#什么是springcloud-stream" class="header-anchor">#</a> 什么是SpringCloud Stream?</h3> <p>官方定义SpringCloud Stream是一个构建消息驱动微服务的框架。</p> <p>应用程序通过inputs或者outputs来与SpringCloud Stream中binder对象交互。
通过我们配置来binding（绑定），而SpringCloud Stream的binder对象负责与消息中间件交互。
所以，我们只需要搞清楚如何与SpringCloud Stream交互就可以方便使用消息驱动的方式。</p> <p>通过使用Spring Integration来连接消息代理中间件以实现消息事件驱动。
SpringCloud Stream为一些提供商的消息中间件产品提供了个性化的自动化配置实现，引用了发布-订阅、消费组、分区的三个核心概念。</p> <p>注意：目前仅支持RabbitMQ、Kafka。</p> <h3 id="为什么要用springcloud-stream"><a href="#为什么要用springcloud-stream" class="header-anchor">#</a> 为什么要用SpringCloud Stream?</h3> <p>由于在微服务架构中引入多个MQ，开发维护时需要关注它们的细节，
我们不想关注它们的细节，因此诞生了SpringCloud Stream。
它可以屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型。</p> <h3 id="官网"><a href="#官网" class="header-anchor">#</a> 官网</h3> <p>http://spring.io/projects/spring-cloud-stream#overview</p> <h3 id="binder"><a href="#binder" class="header-anchor">#</a> Binder</h3> <p>在没有绑定器这个概念的情况下，我们的springBoot应用要直接与消息中间件进行消息交互的时候，由于各消息中间件构建的初衷不同，
它们的实现细节上会有较大的差异性，通过定义绑定器作为中间层，完美的实现了应用程序与消息中间件细节之间的隔离。
Stream对消息中间件的进一步封装，可以做到代码层面对中间件的无感知，甚至于动态的切换中间件（rabbitMQ切换为kafka），
使得微服务开发得高度解耦，服务可以关注更多自己得业务流程</p> <p><img src="/assets/img/cloud_stream.ad8bfbbb.png" alt="An image"></p> <p>通过定义绑定器Binder作为中间层，实现了应用程序于消息中间件细节之间的隔离。</p> <h3 id="springcloud-stream标准流程"><a href="#springcloud-stream标准流程" class="header-anchor">#</a> SpringCloud Stream标准流程</h3> <p>1.Binder</p> <p>很方便的连接中间件，屏蔽差异</p> <p>2.Channel</p> <p>通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</p> <p>3.Source和Sink</p> <p>简单的可理解为参照对象是SpringCloud Stream自身，从Stream发布消息就是输出，接受消息就是输入。</p> <p><img src="/assets/img/stream_taolu.d422b80b.png" alt="An image"></p> <h3 id="生产者于消费者"><a href="#生产者于消费者" class="header-anchor">#</a> 生产者于消费者</h3> <p>接下来添加3个模块</p> <h4 id="_1-8801，作为消息生产者"><a href="#_1-8801，作为消息生产者" class="header-anchor">#</a> 1.8801，作为消息生产者</h4> <p>引入中间件依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- stream --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>application.yml:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8801</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitmq的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于于binding整合</span>
         <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息组件类型</span>
         <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitmq的相关的环境配置</span>
          <span class="token key atrule">spring</span><span class="token punctuation">:</span>
            <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
              <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
              <span class="token key atrule">prot</span><span class="token punctuation">:</span> <span class="token number">5672</span>
              <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
              <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
       <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
        <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的Exchange名称的定义</span>
        <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，本文则设置“text/plain”</span>
        <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认30秒)</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token comment">#Eureka服务端在收到最后一次心跳后等待时间上限，默认是90秒，超时将剔除服务</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token comment"># 在信息列表时显示主机名称</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> send<span class="token punctuation">-</span>8801.com
    <span class="token comment"># 访问的路劲变为IP地址</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>接口定义一个发送方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接口实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">IMessageProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">EnableBinding</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">Source</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">MessageChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span>UUID<span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>  <span class="token comment">//定义消息的推送管道</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IMessageProviderImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageChannel</span> output<span class="token punctuation">;</span> <span class="token comment">// 消息发送管道</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> serial <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;*****serial：&quot;</span><span class="token operator">+</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>用Controller测试：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">IMessageProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IMessageProvider</span> iMessageProvider<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sendMessage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> iMessageProvider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>启动测试，进入RabbitMQ管理页面可以看到Exchanges有我们的studyExchange</p> <p><img src="/assets/img/MQ_studyExchange.d5319a97.png" alt="An image"></p> <p>发送消息可以看到：</p> <p><img src="/assets/img/MQ_send.d952bc29.png" alt="An image"></p> <h4 id="_2-8802，作为消息接收者"><a href="#_2-8802，作为消息接收者" class="header-anchor">#</a> 2.8802，作为消息接收者</h4> <p>引入中间件依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- stream --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>applicaiton.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8802</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitmq的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于于bingding整合</span>
         <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息组件类型</span>
         <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitmq的相关的环境配置</span>
          <span class="token key atrule">spring</span><span class="token punctuation">:</span>
            <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
              <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
              <span class="token key atrule">prot</span><span class="token punctuation">:</span> <span class="token number">5672</span>
              <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
              <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span>
       <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
        <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment">#表示要使用的Exchange 名称定义</span>
        <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，本文则设置“text/plain”</span>
        <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7002/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认30秒)</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token comment">#Eureka服务端在收到最后一次心跳后等待时间上限，默认是90秒，超时将剔除服务</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token comment"># 在信息列表时显示主机名称</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> send<span class="token punctuation">-</span>8802.com
    <span class="token comment"># 访问的路劲变为IP地址</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>Controller加入监听，如果8801发送信息这边能接收到并打印控制台</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">EnableBinding</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">StreamListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">Sink</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessageListenerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1号，----&gt;消息:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;prot:&quot;</span> <span class="token operator">+</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>调用8801发送消息接口后，可以看到8802接收到消息并打印</p> <p><img src="/assets/img/receiveMessage.91774e84.png" alt="An image"></p> <h4 id="_3-分组消费于持久化-8803"><a href="#_3-分组消费于持久化-8803" class="header-anchor">#</a> 3.分组消费于持久化 8803</h4> <p>不同组是可以全面消费的（重复消费），
同一组内会发生竞争关系，只有其中一个可以消费。</p> <p>启动8801-8803可以看到它们在不同的组，存在重复消费问题</p> <p><img src="/assets/img/chongfuxiaofei.0feb7acb.png" alt="An image"></p> <p>导致原因：默认分组group是不同的，组流水号不一样，被认为不同组，可以消费</p> <p>解决：8802，8803的配置在input下加上group，使它们在同一分组下就只能有一个被消费</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">group</span><span class="token punctuation">:</span> cloud  <span class="token comment"># 分组名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>group属性还做到了消息的持久化，重启后能够拿到未曾消费的消息</p> <h2 id="springcloud-sleuth分布式请求链路跟踪"><a href="#springcloud-sleuth分布式请求链路跟踪" class="header-anchor">#</a> SpringCloud Sleuth分布式请求链路跟踪</h2> <h3 id="为什么要出现这个技术？要解决的问题？"><a href="#为什么要出现这个技术？要解决的问题？" class="header-anchor">#</a> 为什么要出现这个技术？要解决的问题？</h3> <p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的服务节点调用来协同产生
最后的请求结果，每一个前端请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现
高延时或错误都会引起整个请求最后的失败</p> <h3 id="测试运行"><a href="#测试运行" class="header-anchor">#</a> 测试运行</h3> <p>下载zipkin-server-2.12.9-exec.jar</p> <div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>java -jar zipkin-server-2.12.9-exec.jar运行</p> <p>给8001和80，服务提供者与调用者添加pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 【链路追踪】包含了sleuth+zipkin --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>添加配置applicaiton.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>order  <span class="token comment">#服务名</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span> <span class="token comment">#链路追踪</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#采样率值介于0到1之间，1则表示全部采集</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>进入zipkin前台页面查看链路  http://localhost:9411/zipkin/</p> <p><img src="/assets/img/zipkin.2e0443c7.png" alt="An image"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bd83f740.js" defer></script><script src="/assets/js/2.8f600e53.js" defer></script><script src="/assets/js/3.83f27fa1.js" defer></script>
  </body>
</html>
