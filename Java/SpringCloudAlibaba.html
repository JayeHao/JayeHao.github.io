<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloudAlibaba | HZH BLOG</title>
    <meta name="description" content="我的博客">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.66d45a11.css" as="style"><link rel="preload" href="/assets/js/app.bd83f740.js" as="script"><link rel="preload" href="/assets/js/2.8f600e53.js" as="script"><link rel="preload" href="/assets/js/4.181f67ed.js" as="script"><link rel="prefetch" href="/assets/js/10.1d310c99.js"><link rel="prefetch" href="/assets/js/11.f76918bf.js"><link rel="prefetch" href="/assets/js/12.f55c6a36.js"><link rel="prefetch" href="/assets/js/13.be8b846f.js"><link rel="prefetch" href="/assets/js/14.39795cc9.js"><link rel="prefetch" href="/assets/js/15.493fd799.js"><link rel="prefetch" href="/assets/js/16.8870c587.js"><link rel="prefetch" href="/assets/js/17.67e49c50.js"><link rel="prefetch" href="/assets/js/18.c17bbe7a.js"><link rel="prefetch" href="/assets/js/19.4c37f1fa.js"><link rel="prefetch" href="/assets/js/20.b4309ce1.js"><link rel="prefetch" href="/assets/js/21.025c2b93.js"><link rel="prefetch" href="/assets/js/3.83f27fa1.js"><link rel="prefetch" href="/assets/js/5.c6d93129.js"><link rel="prefetch" href="/assets/js/6.036b0968.js"><link rel="prefetch" href="/assets/js/7.7f15afd9.js"><link rel="prefetch" href="/assets/js/8.28d0222e.js"><link rel="prefetch" href="/assets/js/9.0bebed08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.66d45a11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HZH BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/RelationalDatabase/" class="nav-link">
  关系型数据库
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/NodeJs/" class="nav-link">
  NodeJs
</a></li><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JayeHao?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SpringCloudAlibaba</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Java/SpringCloudAlibaba.html#入门简介" class="sidebar-link">入门简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#为什么会出现springcloudalibaba？" class="sidebar-link">为什么会出现SpringCloudAlibaba？</a></li></ul></li><li><a href="/Java/SpringCloudAlibaba.html#nacos服务注册和配置中心" class="sidebar-link">Nacos服务注册和配置中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#官网" class="sidebar-link">官网</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#开始使用注册中心与配置中心" class="sidebar-link">开始使用注册中心与配置中心</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#集群和持久化配置" class="sidebar-link">集群和持久化配置</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#nacos集群" class="sidebar-link">Nacos集群</a></li></ul></li><li><a href="/Java/SpringCloudAlibaba.html#sentinel-实现熔断与限流" class="sidebar-link">Sentinel 实现熔断与限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#sentinel启动" class="sidebar-link">Sentinel启动</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#新建8401测试微服务" class="sidebar-link">新建8401测试微服务</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#流控模式" class="sidebar-link">流控模式</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#熔断降级" class="sidebar-link">熔断降级</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#热点规则" class="sidebar-link">热点规则</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#系统自适应限流" class="sidebar-link">系统自适应限流</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#sentinelresource-自定义限流处理逻辑" class="sidebar-link">@SentinelResource 自定义限流处理逻辑</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#规则持久化" class="sidebar-link">规则持久化</a></li></ul></li><li><a href="/Java/SpringCloudAlibaba.html#seata处理分布式事务" class="sidebar-link">Seata处理分布式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#官网-2" class="sidebar-link">官网</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#术语" class="sidebar-link">术语</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#开始使用" class="sidebar-link">开始使用</a></li><li class="sidebar-sub-header"><a href="/Java/SpringCloudAlibaba.html#seata-原理简介" class="sidebar-link">Seata 原理简介</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springcloudalibaba"><a href="#springcloudalibaba" class="header-anchor">#</a> SpringCloudAlibaba</h1> <h2 id="入门简介"><a href="#入门简介" class="header-anchor">#</a> 入门简介</h2> <h3 id="为什么会出现springcloudalibaba？"><a href="#为什么会出现springcloudalibaba？" class="header-anchor">#</a> 为什么会出现SpringCloudAlibaba？</h3> <p>Spring CLoud Netflix 项目进入维护模式</p> <h2 id="nacos服务注册和配置中心"><a href="#nacos服务注册和配置中心" class="header-anchor">#</a> Nacos服务注册和配置中心</h2> <h3 id="官网"><a href="#官网" class="header-anchor">#</a> 官网</h3> <p>https://nacos.io/en-us/</p> <h3 id="开始使用注册中心与配置中心"><a href="#开始使用注册中心与配置中心" class="header-anchor">#</a> 开始使用注册中心与配置中心</h3> <p>Nacos自带ribbon所以支持负载均衡，并采用默认轮询算法</p> <p>启动后控制台页面</p> <p>http://localhost:8848/nacos/#/login</p> <p>注册中心直接看官方文档，很简单</p> <p>https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</p> <p>中文文档：</p> <p>https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</p> <h4 id="配置管理"><a href="#配置管理" class="header-anchor">#</a> 配置管理</h4> <p>Nacos有三层：</p> <p>spring.cloud.nacos.config.namespace &gt; spring.cloud.nacos.config.group &gt; spring.profile.active</p> <p>命名空间（例如华北机房与华南机房） &gt; 分组（例如开发组与测试组） &gt; 环境（例如开发环境，测试环境）</p> <p>大概看这张图就差不多懂了</p> <p><img src="/assets/img/nacos_config.52c59640.png" alt="An image"></p> <h3 id="集群和持久化配置"><a href="#集群和持久化配置" class="header-anchor">#</a> 集群和持久化配置</h3> <h4 id="nacos切换数据库-windows"><a href="#nacos切换数据库-windows" class="header-anchor">#</a> Nacos切换数据库(windows)</h4> <p>自带嵌入式数据库derby切换到mysql</p> <p>执行安装目录的conf目录下的nacos-mysql.sql脚本初始化数据库环境</p> <p>官网内容：</p> <p><img src="/assets/img/nacos_windows.c9e9cf0e.png" alt="An image"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>platform<span class="token operator">=</span>mysql

db<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span>
db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">11.162</span><span class="token number">.196</span><span class="token number">.16</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>nacos_devtest<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span>
db<span class="token punctuation">.</span>user<span class="token operator">=</span>nacos_devtest
db<span class="token punctuation">.</span>password<span class="token operator">=</span>youdontknow
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由于机器装的8.0.19mysql，单机版不支持不想下源码修改，然后就跳过</p> <p>如果修改源码成功打包，配置的时候jdbc要加：serverTimezone=GMT%2B8 时区来适应mysql8</p> <h3 id="nacos集群"><a href="#nacos集群" class="header-anchor">#</a> Nacos集群</h3> <h4 id="配置集群步骤"><a href="#配置集群步骤" class="header-anchor">#</a> 配置集群步骤</h4> <h5 id="_1-linux服务器上mysql数据库配置"><a href="#_1-linux服务器上mysql数据库配置" class="header-anchor">#</a> 1.Linux服务器上mysql数据库配置</h5> <p>如上【Nacos切换数据库】</p> <h4 id="_2-修改集群地址配置"><a href="#_2-修改集群地址配置" class="header-anchor">#</a> 2.修改集群地址配置</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 先复制一份</span>
<span class="token function">cp</span> cluster.conf.example cluster.conf

<span class="token comment"># 修改我们复制的</span>
<span class="token comment"># 要在里面填写 hostname -i 查看的真实ip地址</span>
cluster.conf

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_3-修改startup-sh"><a href="#_3-修改startup-sh" class="header-anchor">#</a> 3.修改startup.sh</h4> <p><img src="/assets/img/nacos_startup.bf4e3bc3.png" alt="An image"></p> <p><img src="/assets/img/nacos_startup2.e12f54fb.png" alt="An image"></p> <h4 id="_4-配置nginx-conf"><a href="#_4-配置nginx-conf" class="header-anchor">#</a> 4.配置nginx.conf</h4> <p><img src="/assets/img/nginx_conf.c05868f2.png" alt="An image"></p> <h4 id="_5-启动nginx"><a href="#_5-启动nginx" class="header-anchor">#</a> 5.启动nginx</h4> <p>./nginx -c /apps/myNginx/conf/nginx.conf</p> <h4 id="_6-访问nginx的http-192-168-172-22-1111-nacos-新建配置"><a href="#_6-访问nginx的http-192-168-172-22-1111-nacos-新建配置" class="header-anchor">#</a> 6.访问nginx的http://192.168.172.22:1111/nacos/新建配置</h4> <p>可以看到数据库有数据表示搭建完成</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <h2 id="sentinel-实现熔断与限流"><a href="#sentinel-实现熔断与限流" class="header-anchor">#</a> Sentinel 实现熔断与限流</h2> <h3 id="sentinel启动"><a href="#sentinel启动" class="header-anchor">#</a> Sentinel启动</h3> <p>下载的是sentinel-dashboard-1.7.0.jar，java -jar启动即可</p> <p>默认端口8080，账号密码sentinel</p> <p>启动后就能访问控制台了，很方便</p> <p><img src="/assets/img/sentinel.5e916f2a.png" alt="An image"></p> <h3 id="新建8401测试微服务"><a href="#新建8401测试微服务" class="header-anchor">#</a> 新建8401测试微服务</h3> <h4 id="添加sentinel依赖"><a href="#添加sentinel依赖" class="header-anchor">#</a> 添加Sentinel依赖</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="配置连接sentinel"><a href="#配置连接sentinel" class="header-anchor">#</a> 配置连接Sentinel</h4> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8401</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.172.22<span class="token punctuation">:</span><span class="token number">1111  </span><span class="token comment"># nacos注册中心</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 192.168.172.22<span class="token punctuation">:</span><span class="token number">8080  </span><span class="token comment">#sentinel地址</span>
        <span class="token comment"># 默认8719端口，假如占用会自动从8719开始依次+1扫描，直至找到未被占用的端口</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="做一个controller-里面就两个简单的接口"><a href="#做一个controller-里面就两个简单的接口" class="header-anchor">#</a> 做一个controller,里面就两个简单的接口</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>cloudalibaba<span class="token punctuation">.</span>contoller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testA&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-----testA&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testB&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-----testB&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="启动访问"><a href="#启动访问" class="header-anchor">#</a> 启动访问</h4> <p>Sentinel是懒加载的模式，需要访问一次接口才能有监控信息</p> <p><img src="/assets/img/Sentinel_main.2caac931.png" alt="An image"></p> <h3 id="流控模式"><a href="#流控模式" class="header-anchor">#</a> 流控模式</h3> <h4 id="testa-每秒只允许请求一次"><a href="#testa-每秒只允许请求一次" class="header-anchor">#</a> testA 每秒只允许请求一次</h4> <p><img src="/assets/img/Sentinel_testA.d336fecf.png" alt="An image"></p> <h4 id="流控模式规则说明"><a href="#流控模式规则说明" class="header-anchor">#</a> 流控模式规则说明</h4> <ul><li>资源名：唯一名称，默认请求路径</li> <li>针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）</li> <li>阈值类型/单机阈值：
<ul><li>QPS(每秒钟的请求数量)：当调用该api的QPS达到阈值的时候，进行限流</li> <li>线程数：当调用该api的线程数达到阈值的时候，进行限流</li></ul></li> <li>是否集群：不需要集群</li> <li>流控模式：
<ul><li>直接：api达到限流条件时，直接限流</li> <li>关联：当关联的资源达到阈值时，就限流自己</li> <li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【api级别的针对来源】</li></ul></li> <li>流控效果：
<ul><li>快速失败：直接失败，抛异常</li> <li>Warm Up：即预热/冷启动方式。在预热时长内先根据阈值/codeFactor（冷加载因子，默认3）的值流控，经过预热时长，才达到设置的QPS阈值</li> <li>排队等待：匀速排队，让请求以均匀的速度通过，阈值类型必须设置成QPS，否则无效。</li></ul></li></ul> <h3 id="熔断降级"><a href="#熔断降级" class="header-anchor">#</a> 熔断降级</h3> <ul><li>官网说明： https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7</li></ul> <h4 id="降级策略"><a href="#降级策略" class="header-anchor">#</a> 降级策略</h4> <ul><li>RT(平均响应时间)</li></ul> <p>当 1s 内持续进入 5 个请求，对应时刻的平均响应时间（秒级）均超过阈值（count，以 ms 为单位），那么在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 DegradeException）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。</p> <p><img src="/assets/img/Sentinel_RT.ae7b0ccc.png" alt="An image"></p> <ul><li>异常比例</li></ul> <p>当资源的每秒请求量 &gt;= 5，并且每秒异常总数占通过量的比值超过阈值（DegradeRule 中的 count）之后，资源进入降级状态，即在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p> <p><img src="/assets/img/Sentinel_error.57550506.png" alt="An image"></p> <p>每秒进20个线程，阈值设置0.8，时间窗口设置1，请求方法写的是10/0。
结果请求量&gt;5，异常比例100%，跳闸</p> <ul><li>异常数</li></ul> <p>当资源近 1 分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 timeWindow 小于 60s，则结束熔断状态后仍可能再进入熔断状态。</p> <p><img src="/assets/img/Sentinel_err_num.0f659b87.png" alt="An image"></p> <p>上图意思是，当异常数达到5个时，触发降级，在70s后回复。</p> <h3 id="热点规则"><a href="#热点规则" class="header-anchor">#</a> 热点规则</h3> <ul><li>官网说明：
https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81</li></ul> <h4 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h4> <p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p> <ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li> <li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul> <p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p> <p><img src="/assets/img/Sentinel_hot.5ecacfb1.png" alt="An image"></p> <p>Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。热点参数限流支持集群模式。</p> <p>根据官网所描述的，用自己的方式再描述一下</p> <p><img src="/assets/img/Sentinel_hot_myhot.1239cc18.png" alt="An image"></p> <ul><li>资源名：@SentinelResource的value</li> <li>QPS模式：每秒超过阈值则降级</li> <li>参数索引：在接口的下标为0（就是第一个）参数</li> <li>单机阈值：1秒内若带着索引为0（第一个）参数请求次数大于1，拉闸</li> <li>统计窗口时长：1秒内恢复正常</li></ul> <p>参数额外项</p> <ul><li>参数类型：controller参数接收类型</li> <li>参考值：当索引0的参数为6时，指定一个限流阈值</li> <li>限流阈值：当索引0的参数为6时，指定一个限流阈值</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testHotKey&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;deal_testHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;----testHotKey&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deal_testHotKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> p1<span class="token punctuation">,</span> <span class="token class-name">String</span> p2<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-----deal_testHotKey,/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="系统自适应限流"><a href="#系统自适应限流" class="header-anchor">#</a> 系统自适应限流</h3> <ul><li>官网说明
https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</li></ul> <p>Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <h4 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h4> <p>在开始之前，我们先了解一下系统保护的目的：</p> <ul><li>保证系统不被拖垮</li> <li>在系统稳定的前提下，保持系统的吞吐量</li></ul> <p>长期以来，系统保护的思路是根据硬指标，即系统的负载 (load1) 来做系统过载保护。当系统负载高于某个阈值，就禁止或者减少流量的进入；当 load 开始好转，则恢复流量的进入。这个思路给我们带来了不可避免的两个问题：</p> <ul><li>load 是一个“结果”，如果根据 load 的情况来调节流量的通过率，那么就始终有延迟性。也就意味着通过率的任何调整，都会过一段时间才能看到效果。当前通过率是使 load 恶化的一个动作，那么也至少要过 1 秒之后才能观测到；同理，如果当前通过率调整是让 load 好转的一个动作，也需要 1 秒之后才能继续调整，这样就浪费了系统的处理能力。所以我们看到的曲线，总是会有抖动。</li> <li>恢复慢。想象一下这样的一个场景（真实），出现了这样一个问题，下游应用不可靠，导致应用 RT 很高，从而 load 到了一个很高的点。过了一段时间之后下游应用恢复了，应用 RT 也相应减少。这个时候，其实应该大幅度增大流量的通过率；但是由于这个时候 load 仍然很高，通过率的恢复仍然不高。</li></ul> <p>TCP BBR 的思想给了我们一个很大的启发。我们应该根据系统能够处理的请求，和允许进来的请求，来做平衡，而不是根据一个间接的指标（系统 load）来做限流。最终我们追求的目标是 在系统不被拖垮的情况下，提高系统的吞吐率，而不是 load 一定要到低于某个阈值。如果我们还是按照固有的思维，超过特定的 load 就禁止流量进入，系统 load 恢复就放开流量，这样做的结果是无论我们怎么调参数，调比例，都是按照果来调节因，都无法取得良好的效果。</p> <p>Sentinel 在系统自适应保护的做法是，用 load1 作为启动自适应保护的因子，而允许通过的流量由处理请求的能力，即请求的响应时间以及当前系统正在处理的请求速率来决定。</p> <h4 id="系统规则"><a href="#系统规则" class="header-anchor">#</a> 系统规则</h4> <p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <p>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量生效。入口流量指的是进入应用的流量（EntryType.IN），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p> <p>系统规则支持以下的模式：</p> <ul><li>Load 自适应（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。</li> <li>CPU usage（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li> <li>平均 RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li> <li>并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li> <li>入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul> <h3 id="sentinelresource-自定义限流处理逻辑"><a href="#sentinelresource-自定义限流处理逻辑" class="header-anchor">#</a> @SentinelResource 自定义限流处理逻辑</h3> <p>定义全局限流异常处理类，注意方法必须为static</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>cloudalibaba<span class="token punctuation">.</span>myhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block</span><span class="token punctuation">.</span><span class="token class-name">BlockException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hzh<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>entities</span><span class="token punctuation">.</span><span class="token class-name">CommonResult</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义限流处理逻辑
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerBlockHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span>exception<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;服务不可用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Controller类@SentinelResource注解演示</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/byResource&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;byResource&quot;</span><span class="token punctuation">,</span>blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomerBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;handlerException&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">byResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;按资源名称限流测试OK&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token number">2020L</span><span class="token punctuation">,</span><span class="token string">&quot;serial001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>如果资源名填的是【/byResource】则依然会走默认的处理方法</li> <li>blockHandler 管控制台流控异常</li> <li>fallback 管java/业务/运行时异常</li></ul> <h3 id="规则持久化"><a href="#规则持久化" class="header-anchor">#</a> 规则持久化</h3> <ul><li>加pom</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> sentinel持久化 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>sentinel<span class="token operator">-</span>datasource<span class="token operator">-</span>nacos<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>yml 添加nacos数据源配置</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code># 配置nacos数据源
spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> nacos<span class="token operator">-</span>order<span class="token operator">-</span>consumer
  cloud<span class="token operator">:</span>
    nacos<span class="token operator">:</span>
      discovery<span class="token operator">:</span>
        server<span class="token operator">-</span>addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.172</span><span class="token number">.22</span><span class="token operator">:</span><span class="token number">1111</span> # 配置<span class="token class-name">Nacos</span>地址
    sentinel<span class="token operator">:</span>
      transport<span class="token operator">:</span>
        dashboard<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.172</span><span class="token number">.22</span><span class="token operator">:</span><span class="token number">8080</span>  #sentinel地址
        # 默认<span class="token number">8719</span>端口，假如占用会自动从<span class="token number">8719</span>开始依次<span class="token operator">+</span><span class="token number">1</span>扫描，直至找到未被占用的端口
        port<span class="token operator">:</span> <span class="token number">8719</span>
      # 配置nacos数据源
      datasource<span class="token operator">:</span>
        ds1<span class="token operator">:</span>
          nacos<span class="token operator">:</span>
            server<span class="token operator">-</span>addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.172</span><span class="token number">.22</span><span class="token operator">:</span><span class="token number">1111</span>
            dataId<span class="token operator">:</span> cloudalibaba<span class="token operator">-</span>sentinel<span class="token operator">-</span>service
            groupId<span class="token operator">:</span> DEFAULT_GROUP
            data<span class="token operator">-</span>type<span class="token operator">:</span> json
            rule<span class="token operator">-</span>type<span class="token operator">:</span> flow
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>登录nacos新建配置，选json
<ul><li>resource:资源名称</li> <li>limitApp:来源应用</li> <li>grade:阈值类型，0表示线程数，1表示QPS</li> <li>count:单机阈值</li> <li>strategy:流控模式，0表示直接，1表示关联，2表示链路</li> <li>controlBehavior:流控效果，0表示快速失败，1表示Warm up,2表示排队等待</li> <li>clusterMode:是否集群</li></ul></li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/rateLimit/byUrl&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;limitApp&quot;</span><span class="token operator">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;strategy&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;controlBehavior&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;clusterMode&quot;</span><span class="token operator">:</span><span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/assets/img/nacos_sentinel.d0892145.png" alt="An image"></p> <p>接着发现能持久化了。
其实也就是sentinel的配置放到nacos里去</p> <h2 id="seata处理分布式事务"><a href="#seata处理分布式事务" class="header-anchor">#</a> Seata处理分布式事务</h2> <h3 id="官网-2"><a href="#官网-2" class="header-anchor">#</a> 官网</h3> <p>https://seata.io/zh-cn/</p> <h3 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h3> <ul><li>Transaction ID XID (非官网，分布式事务处理过程的-ID+三组件)</li></ul> <p>全局唯一的事务ID</p> <ul><li>TC - 事务协调者</li></ul> <p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p> <ul><li>TM - 事务管理器</li></ul> <p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p> <ul><li>RM - 资源管理器</li></ul> <p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p> <p>图解：</p> <p><img src="/assets/img/seata.069e2056.png" alt="An image"></p> <h3 id="开始使用"><a href="#开始使用" class="header-anchor">#</a> 开始使用</h3> <h4 id="_1-设置数据源-file-conf"><a href="#_1-设置数据源-file-conf" class="header-anchor">#</a> 1.设置数据源 - file.conf</h4> <p>主要修改：自定义事务组名称+事务日志存储模式为db+数据库连接信息</p> <ul><li>自定义事务组名称 - service模块</li></ul> <div class="language- line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-text"><code>service {
  #vgroup-&gt;rgroup
  vgroup_mapping.my_test_tx_group = &quot;fsp_tx_group&quot;
  #only support single node
  default.grouplist = &quot;127.0.0.1:8091&quot;
  #degrade current not support
  enableDegrade = false
  #disable
  disable = false
  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent
  max.commit.retry.timeout = &quot;-1&quot;
  max.rollback.retry.timeout = &quot;-1&quot;
}

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>事务日志存储模式为db - store模块</li></ul> <div class="language- line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-text"><code>## transaction log store
store {
  ## store mode: file、db
  mode = &quot;db&quot;       # file 换成db并指定数据库

  ## file store
  file {
    dir = &quot;sessionStore&quot;

    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions
    max-branch-session-size = 16384
    # globe session size , if exceeded throws exceptions
    max-global-session-size = 512
    # file buffer size , if exceeded allocate new buffer
    file-write-buffer-cache-size = 16384
    # when recover batch read size
    session.reload.read_size = 100
    # async, sync
    flush-disk-mode = async
  }

  ## database store
  db {
    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.
    datasource = &quot;dbcp&quot;
    ## mysql/oracle/h2/oceanbase etc.
    db-type = &quot;mysql&quot;
    driver-class-name = &quot;com.mysql.jdbc.Driver&quot;
    url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot;
    user = &quot;mysql&quot;
    password = &quot;mysql&quot;
    min-conn = 1
    max-conn = 3
    global.table = &quot;global_table&quot;
    branch.table = &quot;branch_table&quot;
    lock-table = &quot;lock_table&quot;
    query-limit = 100
  }
}
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li>初始化db</li></ul> <p>找到seata/conf/db_store.sql 初始化</p> <h4 id="_2-设置注册中心-registry-conf"><a href="#_2-设置注册中心-registry-conf" class="header-anchor">#</a> 2.设置注册中心 - registry.conf</h4> <p>file 改成nacos，并设置nacos地址</p> <div class="language- line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-text"><code>registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;file&quot;
nacos {
    serverAddr = &quot;localhost&quot;
    namespace = &quot;&quot;
    cluster = &quot;default&quot;
  }
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_3-准备3个数据库"><a href="#_3-准备3个数据库" class="header-anchor">#</a> 3.准备3个数据库</h4> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>从上到下依次是</p> <ul><li>账户信息库</li> <li>订单库</li> <li>库存库</li></ul> <p>从上到下依次创建了相应的表</p> <p>seata_account库</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_account<span class="token punctuation">(</span>
    <span class="token string">'id'</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
    <span class="token string">'user_id'</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token string">'total'</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'总额度'</span><span class="token punctuation">,</span>
    <span class="token string">'used'</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'已用余额'</span><span class="token punctuation">,</span>
    <span class="token string">'residue'</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'剩余可用额度'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
 
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> seata_account<span class="token punctuation">.</span>t_account<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'user_id'</span><span class="token punctuation">,</span><span class="token string">'total'</span><span class="token punctuation">,</span><span class="token string">'used'</span><span class="token punctuation">,</span><span class="token string">'residue'</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1000'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1000'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>seata_order库</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>product_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'产品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>count<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>money<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态：0：创建中; 1：已完结'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>seata_storage库</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_storage<span class="token punctuation">(</span>
    <span class="token string">'id'</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    <span class="token string">'product_id'</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'产品id'</span><span class="token punctuation">,</span>
    <span class="token string">'total'</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'总库存'</span><span class="token punctuation">,</span>
    <span class="token string">'used'</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'已用库存'</span><span class="token punctuation">,</span>
    <span class="token string">'residue'</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'剩余库存'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
 
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> seata_storage<span class="token punctuation">.</span>t_storage<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'product_id'</span><span class="token punctuation">,</span><span class="token string">'total'</span><span class="token punctuation">,</span><span class="token string">'used'</span><span class="token punctuation">,</span><span class="token string">'residue'</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'100'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>订单-库存-账户3个库下都需要建各自的回滚日志表</p> <p>\seata-server-0.9.0\seata\conf目录下的db_undo_log.sql</p> <p>最终效果</p> <p><img src="/assets/img/seata_tables.3124e2e6.png" alt="An image"></p> <h4 id="订单-库存-账户三个微服务"><a href="#订单-库存-账户三个微服务" class="header-anchor">#</a> 订单-库存-账户三个微服务</h4> <p>在主业务方法上加上下面注解就能做到分布式事务控制</p> <p>@GlobalTransactional(name = &quot;fsp_tx_group&quot;,rollbackFor = Exception.class)</p> <p>@GlobalTransactional里当然还有很多属性，有时间深入研究</p> <h4 id="分布式事务的执行流程"><a href="#分布式事务的执行流程" class="header-anchor">#</a> 分布式事务的执行流程</h4> <ul><li>TM开启分布式事务(TM向TC注册全局事务记录)</li> <li>换业务场景，编排数据库，服务等事务内资源（RM向TC汇报资源准备状态）</li> <li>TM结束分布式事务，事务一阶段结束（TM通知TC提交/回滚分布式事务）</li> <li>TC汇总事务信息，决定分布式事务是提交还是回滚</li> <li>TC通知所有RM提交/回滚资源，事务二阶段结束。</li></ul> <p>贴一张 TC - TM - RM 的理解图</p> <p><img src="/assets/img/seata_end.e2dad7de.png" alt="An image"></p> <h3 id="seata-原理简介"><a href="#seata-原理简介" class="header-anchor">#</a> Seata 原理简介</h3> <h4 id="一阶段加载"><a href="#一阶段加载" class="header-anchor">#</a> 一阶段加载</h4> <p><img src="/assets/img/Seata_01.02815129.png" alt="An image"></p> <h4 id="二阶段提交（正常情况）"><a href="#二阶段提交（正常情况）" class="header-anchor">#</a> 二阶段提交（正常情况）</h4> <p><img src="/assets/img/Seata_02.f8f35a4c.png" alt="An image"></p> <h4 id="二阶段回滚（异常情况）"><a href="#二阶段回滚（异常情况）" class="header-anchor">#</a> 二阶段回滚（异常情况）</h4> <p><img src="/assets/img/Seata_02.f8f35a4c.png" alt="An image"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bd83f740.js" defer></script><script src="/assets/js/2.8f600e53.js" defer></script><script src="/assets/js/4.181f67ed.js" defer></script>
  </body>
</html>
